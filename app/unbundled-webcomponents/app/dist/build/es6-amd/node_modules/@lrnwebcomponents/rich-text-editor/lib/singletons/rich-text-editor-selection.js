define(["exports","../../../../lit-element/lit-element.js","../rich-text-editor-styles.js","../../../utils/utils.js"],(function(_exports,_litElement,_richTextEditorStyles,_utils){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.RichTextEditorSelection=void 0;
/**
   * Copyright 2019 Penn State University
   * @license Apache-2.0, see License.md for full text.
   */
class RichTextEditorSelection extends((0,_richTextEditorStyles.RichTextEditorStyles)(_litElement.LitElement)){static get tag(){return"rich-text-editor-selection"}static get styles(){return[...super.styles,_litElement.css`
        :host {
          background-color: var(--rich-text-editor-selection-bg);
          margin: 0;
          padding: 0;
          display: inline;
        }
        :host([hidden]) {
          display: none;
        }
        :host([collapsed]):after {
          content: '|';
          color: var(--rich-text-editor-selection-bg);
          background-color: transparent;
        }
      `]}render(){return _litElement.html` <slot></slot> `}static get properties(){return{editor:{type:Object},collapsed:{type:Boolean,reflect:!0,attribute:"collapsed"},hidden:{type:Boolean,reflect:!0,attribute:"hidden"},id:{type:String,reflect:!0,attribute:"id"},observer:{type:Object},range:{type:Object},toolbar:{type:Object},__toolbars:{type:Array}}}constructor(){super();this.hidden=!0,this.__toolbars=[],this.__clipboard=document.createElement("textarea"),this.__clipboard.setAttribute("aria-hidden",!0),this.__clipboard.style.position="absolute",this.__clipboard.style.left="-9999px",this.__clipboard.style.top="0px",this.__clipboard.style.width="0px",this.__clipboard.style.height="0px",this.id=this._generateUUID(),document.body.appendChild(this.__clipboard),window.addEventListener("paste",e=>console.log("paste",e)),window.addEventListener("register",this._handleRegistration.bind(this))}updated(changedProperties){super.updated(changedProperties),changedProperties.forEach((oldValue,propName)=>{})}disconnectedCallback(){super.disconnectedCallback()}cancelEdits(editor){editor.revert(),this.edit(editor,!1)}disableEditing(editor){editor&&(this.getRoot(editor).onselectionchange=void 0,editor.contenteditable=!1,editor.makeSticky(!1))}execCommand(command,val,range,toolbar){console.log(">>>>>>>> execCommand",command,val,range,toolbar,!range||range.cloneContents());let editor=toolbar.editor;if(range){if(this.range=editor.range,this.updateRange(editor,range),this.selectRange(range,editor),"replaceHTML"===command){this.getRangeNode().innerHTML=val}else"paste"!==command?(console.log("command",range,this.getRangeNode()),document.execCommand(command,!1,val)):navigator.clipboard&&this.pasteFromClipboard(editor);this.highlight(toolbar,!1)}}edit(editor,editable=!0){let toolbar=editor?this.getConnectedToolbar(editor):void 0,oldEditor=editable?toolbar.editor:void 0;this.highlight(editor,!1),toolbar&&oldEditor!==editor&&(this.disableEditing(oldEditor),toolbar.editor=editor,this.enableEditing(editor,toolbar))}enableEditing(editor,toolbar=this.getConnectedToolbar(editor)){editor&&(editor.makeSticky(toolbar.sticky),editor.parentNode.insertBefore(toolbar,editor),editor.contenteditable=!0,this.updateRange(editor),this.getRoot(editor).onselectionchange=e=>this.updateRange(editor))}expandRangeTo(selectors="",range){let node=range?this.getRangeNode(range):void 0,tagName=node&&node.tagName?node.tagName.toLowerCase():void 0;return selectors.toLowerCase().replace(/\s*/g,"").split(",").includes(tagName)?node:node.closest(selectors)?(range.selectNode(node.closest(selectors)),range):void 0}getRangeNode(range){let common=range?range.commonAncestorContainer:void 0,startContainer=range?range.startContainer:void 0,startOffset=range?range.startOffset:void 0,endContainer=range?range.endContainer:void 0,endOffset=range?range.endOffset:void 0,startNode=startContainer&&startContainer.children?startContainer.children[startOffset-1]:void 0;return startContainer===endContainer&&endOffset-startOffset==1?startNode:common}getRoot(node){return node&&node!==document?node.parentNode?this.getRoot(node.parentNode):node:document}getSanitizeClipboard(pasteContent){let regex="<body(.*\n)*>(.*\n)*</body>";return pasteContent.match(regex)&&pasteContent.match(regex).length>0&&(pasteContent=pasteContent.match(regex)[0].replace(/<\?body(.*\n)*\>/i)),pasteContent}getConnectedToolbar(editor){if(editor.id||(editor.id=this._generateUUID()),!editor.__connectedToolbar){let toolbar,filter=editor.toolbar?(this.__toolbars||[]).filter(toolbar=>toolbar.id===editor.toolbar):[];0===filter.length&&(filter=editor.type?(this.__toolbars||[]).filter(toolbar=>toolbar.type===editor.type):[]),filter[0]?toolbar=filter[0]:0===filter.length&&(toolbar=document.createElement(editor.type||"rich-text-editor-toolbar"),editor.parentNode.insertBefore(toolbar,editor)),toolbar.id=editor.toolbar||this._generateUUID(),editor.toolbar=toolbar.id,editor.__connectedToolbar=toolbar}return editor.__connectedToolbar}highlightNode(node,toolbar){this.selectNode(node,toolbar.range),this.highlight(toolbar)}highlight(toolbar,add=!0){this.toolbar=toolbar;toolbar.editor;!1!==add?toolbar.range&&(this.hidden=!1,toolbar.range.insertNode(this),toolbar.range.setStartAfter(this),this.range=toolbar.range):(this.updateRange(toolbar.editor,toolbar.range),this.hidden=!0,this.toolbar=void 0,this.range=void 0,document.body.appendChild(this))}pasteFromClipboard(editor){console.log("pasteFromClipboard",editor),setTimeout(async()=>{let sel=window.getSelection(),range=editor.range,text=await navigator.clipboard.readText();this.__clipboard.value=text,this.__clipboard.focus(),this.__clipboard.select(),document.execCommand("paste"),sel.removeAllRanges(),sel.addRange(range),this.pasteIntoEditor(editor,this.__clipboard.value)},2e3)}pasteIntoEditor(editor,pasteContent,sanitize=!0){console.log("pasteIntoEditor",editor),editor&&this.pasteIntoRange(editor,editor.range,sanitize?this.getSanitizeClipboard(pasteContent):pasteContent)}pasteIntoRange(editor,range,pasteContent){console.log("pasteIntoRange",editor);let div=document.createElement("div");if(editor=range.commonAncestorContainer.parentNode.closest("[contenteditable=true]:not([disabled]),input:not([disabled]),textarea:not([disabled])")){for(div.innerHTML=pasteContent,range&&range.extractContents&&range.extractContents(),range.insertNode(div);div.firstChild;)div.parentNode.insertBefore(div.firstChild,div);div.parentNode.removeChild(div)}}registerEditor(editor,remove=!1){let toolbar=editor?this.getConnectedToolbar(editor):void 0,handlers={focus:e=>this.edit(editor),blur:e=>this._handleBlur(editor,e),keydown:e=>this._handleShortcutKeys(editor,e),click:e=>this._handleEditorClick(editor,e),getrange:e=>{this.toolbar=toolbar,this.updateRange(editor,editor.range)},pastefromclipboard:e=>this.pasteFromClipboard(e.detail),pastecontent:e=>this._handlePaste(e)};return remove?(editor.removeEventListener("mousedown",handlers.focus),editor.removeEventListener("focus",handlers.focus),editor.removeEventListener("keydown",handlers.keydown),editor.removeEventListener("blur",handlers.blur),editor.removeEventListener("getrange",handlers.getrange),editor.removeEventListener("pastefromclipboard",handlers.pastefromclipboard),editor.removeEventListener("pastecontent",handlers.pastecontent)):(editor.addEventListener("mousedown",handlers.focus),editor.addEventListener("focus",handlers.focus),editor.addEventListener("keydown",handlers.keydown),editor.addEventListener("blur",handlers.blur),editor.addEventListener("getrange",handlers.getrange),editor.addEventListener("pastefromclipboard",handlers.pastefromclipboard),editor.addEventListener("pastecontent",handlers.pastecontent)),editor.__connectedToolbar}registerToolbar(toolbar,remove=!1){let handlers={exec:e=>{e.stopImmediatePropagation(),this.execCommand(e.detail.command,e.detail.commandVal,e.detail.range,toolbar)},highlight:e=>{e.stopImmediatePropagation(),this.highlight(toolbar.editor,e.detail)},highlightnode:e=>{e.stopImmediatePropagation(),this.highlightNode(e.detail,toolbar)},selectnode:e=>{e.stopImmediatePropagation(),this.selectNode(e.detail,toolbar.range)},selectnodecontents:e=>{e.stopImmediatePropagation(),this.selectNode(e.detail,toolbar.range)},selectrange:e=>{e.stopImmediatePropagation(),this.selectRange(e.detail,toolbar.editor)},pastefromclipboard:e=>{e.stopImmediatePropagation(),this.pasteFromClipboard(e.detail)},wrapselection:e=>{e.stopImmediatePropagation(),this.surroundRange(e.detail,toolbar.range)}};remove||toolbar.registered?(toolbar.registered=!1,toolbar.removeEventListener("command",handlers.exec),toolbar.removeEventListener("highlight",handlers.highlight),toolbar.removeEventListener("highlightnode",handlers.highlightnode),toolbar.removeEventListener("selectnode",handlers.selectnode),toolbar.removeEventListener("selectnodecontents",handlers.selectnodecontents),toolbar.removeEventListener("selectrange",handlers.selectrange),toolbar.removeEventListener("pastefromclipboard ",handlers.pastefromclipboard),this.__toolbars=this.__toolbars.filter(bar=>bar!==toolbar)):(this.__toolbars.push(toolbar),toolbar.addEventListener("command",handlers.exec),toolbar.addEventListener("highlight",handlers.highlight),toolbar.addEventListener("highlightnode",handlers.highlightnode),toolbar.addEventListener("selectnode",handlers.selectnode),toolbar.addEventListener("selectnodecontents",handlers.selectnodecontents),toolbar.addEventListener("selectrange",handlers.selectrange),toolbar.addEventListener("pastefromclipboard ",handlers.pastefromclipboard),toolbar.addEventListener("wrapselection ",handlers.wrapselection),toolbar.registered=!0)}selectNode(node,range,editor=this.toolbar.editor){range&&(range.selectNode(node),editor&&this.updateRange(editor,range))}selectNodeContents(node,range,editor=this.toolbar.editor){if(node){if(!range){let sel=window.getSelection();range=document.createRange(),sel.removeAllRanges(),sel.addRange(range)}editor&&this.updateRange(editor)}}selectRange(range,select=!0,editor){if(range){if(select){let sel=window.getSelection();sel.removeAllRanges(),sel.addRange(range)}else range.isCollapsed||range.collapse();editor&&this.updateRange(editor)}return range}surroundRange(node,range){return range&&(range.surroundContents(node),editor&&this.updateRange(editor)),range}updateRange(editor,range){if(editor){let toolbar=this.getConnectedToolbar(editor);this.toolbar=toolbar,range||(range=editor.range),editor.range=range,toolbar&&(toolbar.selectedNode=editor.selectedNode,toolbar.selectionAncestors=editor.selectionAncestors,toolbar.range=range)}}_generateUUID(){let hex=Math.floor(65536*(1+Math.random())).toString(16).substring(1);return"rte-"+"ss-s-s-s-sss".replace(/s/g,hex)}_handleBlur(editor,e){null===e.relatedTarget||"rich-text-editor"===!e.relatedTarget.startsWith?this.edit(editor,!0):editor&&this.highlight(editor)}_handleEditorClick(editor,e){editor&&this.getConnectedToolbar(editor),(0,_utils.normalizeEventPath)(e)[0]}_handleRegistration(e){e.detail&&(e.detail.toolbar&&this.registerToolbar(e.detail.toolbar,e.detail.remove),e.detail.editor&&this.registerEditor(e.detail.editor,e.detail.remove))}_handleShortcutKeys(editor,e){let toolbar=editor?this.getConnectedToolbar(editor):void 0;if(editor.contenteditable){let key=e.key;e.shiftKey&&(key="shift+"+key),e.altKey&&(key="alt+"+key),("MacIntel"===window.navigator.platform&&e.metaKey||e.ctrlKey)&&(key="ctrl+"+key),toolbar.shortcutKeys[key]&&toolbar.shortcutKeys[key]._keysPressed(e)}}}_exports.RichTextEditorSelection=RichTextEditorSelection,window.customElements.define(RichTextEditorSelection.tag,RichTextEditorSelection),window.RichTextEditorSelection={},window.RichTextEditorSelection.instance=null,window.RichTextEditorSelection.requestAvailability=function(){return null==window.RichTextEditorSelection.instance&&(window.RichTextEditorSelection.instance=document.createElement(RichTextEditorSelection.tag),document.body.appendChild(window.RichTextEditorSelection.instance)),window.RichTextEditorSelection.instance}}));