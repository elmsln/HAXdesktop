define(["exports","meta","require","../../lit-element/lit-element.js","../simple-colors/simple-colors.js","../undo-manager/undo-manager.js","./lib/hax-store.js","../../mobx/dist/mobx.esm.js","../utils/utils.js"],(function(_exports,meta,_require,_litElement,_simpleColors,_undoManager,_haxStore,_mobxEsm,_utils){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.HaxBody=void 0,meta=babelHelpers.interopRequireWildcard(meta),_require=babelHelpers.interopRequireWildcard(_require),Element.prototype.replaceWith||(Element.prototype.replaceWith=_utils.ReplaceWithPolyfill),CharacterData.prototype.replaceWith||(CharacterData.prototype.replaceWith=_utils.ReplaceWithPolyfill),DocumentType.prototype.replaceWith||(DocumentType.prototype.replaceWith=_utils.ReplaceWithPolyfill),String.prototype.replaceAll||(String.prototype.replaceAll=function(find,replace){return this.split(find).join(replace)});var gravityScrollTimer=null;class HaxBody extends((0,_undoManager.UndoManagerBehaviors)(_simpleColors.SimpleColors)){static get tag(){return"hax-body"}static get styles(){return[...super.styles,_litElement.css`
        :host([edit-mode]),
        :host([edit-mode]) * ::slotted(*) {
          line-height: 1.8;
        }
        :host([edit-mode]) ul,
        :host([edit-mode]) ol {
          padding-left: 20px;
          margin-left: 20px;
        }
        :host([edit-mode]) ul {
          list-style-type: disc;
        }
        :host([edit-mode]) li {
          margin-bottom: 6px;
        }
        :host {
          display: block;
          position: relative;
          min-height: 32px;
          min-width: 32px;
          outline: none;
          --hax-contextual-action-text-color: var(
            --simple-colors-default-theme-grey-1,
            #fff
          );
          --hax-contextual-action-hover-color: var(
            --simple-colors-default-theme-grey-8,
            #009dc7
          );
          --hax-contextual-action-color: var(
            --simple-colors-default-theme-grey-12,
            #007999
          );
          --hax-body-editable-outline: 0px solid
            var(--simple-colors-default-theme-grey-4, #eeeeee);
          --hax-body-active-outline-hover: 1px solid
            var(--simple-colors-default-theme-grey-8, #eeeeee);
          --hax-body-active-outline: 0px solid
            var(
              --hax-contextual-action-hover-color,
              var(--simple-colors-default-theme-cyan-7, #009dc7)
            );
          --hax-body-active-drag-outline: 1px solid
            var(
              --hax-contextual-action-hover-color,
              var(--simple-colors-default-theme-cyan-7, #009dc7)
            );
          --hax-body-target-background-color: var(
            --simple-colors-default-theme-grey-11,
            #009dc7
          );
          --hax-body-possible-target-background-color: inherit;
        }
        #addincontext {
          opacity: 0.5;
          transition: 0.2s opacity ease-in-out;
        }
        #addincontext:hover,
        #addincontext:active,
        #addincontext:focus {
          opacity: 1;
          cursor: pointer;
        }
        .hax-context-menu {
          padding: 0;
          margin-left: -5000px;
          position: fixed;
          visibility: hidden;
          opacity: 0;
          z-index: 1000;
          float: left;
          display: block;
          pointer-events: none;
          transition: 0.2s top ease-in-out, 0.2s left ease-in-out;
        }
        #textcontextmenu.hax-context-menu {
          z-index: 1000;
        }
        .hax-context-visible {
          position: absolute;
          visibility: visible;
          pointer-events: all;
          opacity: 1;
        }
        .hax-context-menu-active {
          margin-left: unset;
        }
        :host([edit-mode]) #bodycontainer ::slotted([contenteditable]) {
          -webkit-appearance: textfield;
          cursor: text;
          -moz-user-select: text;
          -khtml-user-select: text;
          -webkit-user-select: text;
          -o-user-select: text;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted([contenteditable][data-hax-ray]:empty):before {
          content: attr(data-hax-ray);
          opacity: 0.2;
          transition: 0.2s all ease-in-out;
        }

        :host([edit-mode])
          #bodycontainer
          ::slotted([contenteditable][data-hax-ray]:hover:empty):before {
          opacity: 0.4;
          cursor: text;
        }

        :host([edit-mode])
          #bodycontainer
          ::slotted([contenteditable][data-hax-ray]:empty:focus):before {
          content: "";
        }
        :host([edit-mode]) #bodycontainer ::slotted(p) {
          min-height: var(--hax-base-styles-p-min-height, 1rem);
          font-size: var(--hax-base-styles-p-font-size);
          line-height: var(--hax-base-styles-p-line-height);
          letter-spacing: var(--hax-base-styles-p-letter-spacing);
        }
        :host([edit-mode]) #bodycontainer ::slotted(a) {
          color: var(--hax-base-styles-a-color);
          font-size: var(
            --hax-base-styles-a-font-size,
            var(--hax-base-styles-p-font-size)
          );
          font-weight: var(--hax-base-styles-a-font-weight);
        }
        :host([edit-mode]) #bodycontainer ::slotted(a:visited) {
          color: var(--hax-base-styles-a-color-visited);
        }
        :host([edit-mode]) #bodycontainer ::slotted(a:active),
        :host([edit-mode]) #bodycontainer ::slotted(a:focus),
        :host([edit-mode]) #bodycontainer ::slotted(a:hover) {
          color: var(--hax-base-styles-a-color-active);
          font-weight: var(--hax-base-styles-a-font-weight-active);
        }
        :host([edit-mode]) #bodycontainer ::slotted(ol),
        :host([edit-mode]) #bodycontainer ::slotted(ul),
        :host([edit-mode]) #bodycontainer ::slotted(li) {
          padding-bottom: var(--hax-base-styles-list-padding-bottom);
          line-height: var(
            --hax-base-styles-list-line-height,
            var(--hax-base-styles-p-line-height)
          );
          font-size: var(
            --hax-base-styles-list-font-size,
            var(--hax-base-styles-p-font-size)
          );
        }
        :host([edit-mode]) #bodycontainer ::slotted(ol > li:last-child),
        :host([edit-mode]) #bodycontainer ::slotted(ul > li:last-child) {
          padding-bottom: var(--hax-base-styles-list-last-child-padding-bottom);
        }
        :host([edit-mode]) #bodycontainer ::slotted(img[contenteditable]) {
          max-width: 100%;
        }
        :host([edit-mode]) #bodycontainer ::slotted(*[contenteditable]) {
          outline: none;
          caret-color: auto;
        }
        :host([edit-mode]) #bodycontainer ::slotted(*.blinkfocus) {
          outline: 4px solid var(--hax-contextual-action-hover-color);
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*:not(grid-plate)[contenteditable]:hover) {
          outline: var(--hax-body-active-outline-hover);
          caret-color: auto;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*.hax-active[contenteditable]:hover) {
          cursor: text !important;
          caret-color: auto;
          outline: var(--hax-body-active-outline-hover);
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*:not(grid-plate)[contenteditable] .hax-active:hover) {
          cursor: text !important;
          caret-color: auto;
          outline: var(--hax-body-active-outline-hover);
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(code.hax-active[contenteditable]) {
          display: block;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*.hax-active[contenteditable]) {
          outline: var(--hax-body-active-outline) !important;
        }
        :host([edit-mode]) #bodycontainer ::slotted(hr[contenteditable]) {
          height: 2px;
          background-color: #eeeeee;
          padding-top: 4px;
          padding-bottom: 4px;
        }
        /** Fix to support safari as it defaults to none */
        :host([edit-mode]) #bodycontainer ::slotted(*[contenteditable]) {
          -webkit-user-select: text;
          cursor: pointer;
        }

        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable]::-moz-selection),
        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable] *::-moz-selection) {
          background-color: var(
            --hax-body-highlight,
            var(--simple-colors-default-theme-yellow-2, yellow)
          );
          color: black;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable]::selection),
        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable] *::selection) {
          background-color: var(
            --hax-body-highlight,
            var(--simple-colors-default-theme-yellow-2, yellow)
          );
          color: black;
        }
        #bodycontainer {
          -webkit-user-select: text;
          user-select: text;
        }
        .hax-context-menu:not(:defined) {
          display: none;
        }
        /* drag and drop */
        :host([edit-mode][hax-mover]) #bodycontainer ::slotted(*):before {
          background-color: var(--hax-body-possible-target-background-color);
          content: " ";
          width: 100%;
          display: block;
          position: relative;
          margin: -12px 0 0 0;
          z-index: 2;
          height: 12px;
          transition: 0.2s all ease-in-out;
        }
        :host([edit-mode][hax-mover]) #bodycontainer ::slotted(img) {
          outline: var(--hax-body-editable-outline);
        }
        :host([edit-mode]) #bodycontainer ::slotted(img.hax-hovered),
        :host([edit-mode]) #bodycontainer ::slotted(*.hax-hovered):before {
          background-color: var(--hax-body-target-background-color) !important;
        }
        :host([edit-mode]) #bodycontainer ::slotted(img.hax-hovered) {
          border-top: 8px
            var(
              --hax-contextual-action-hover-color,
              var(--simple-colors-default-theme-cyan-7, #009dc7)
            );
          margin-top: -8px;
        }

        @media screen and (min-color-index: 0) and(-webkit-min-device-pixel-ratio:0) {
          /*
            Define here the CSS styles applied only to Safari browsers
            (any version and any device) via https://solvit.io/bcf61b6
          */
          :host([edit-mode][hax-mover]) #bodycontainer ::slotted(*) {
            outline: var(--hax-body-editable-outline);
            background-color: var(--hax-body-possible-target-background-color);
          }
          :host([edit-mode]) #bodycontainer ::slotted(*.hax-hovered) {
            background-color: var(
              --hax-body-target-background-color
            ) !important;
            outline: var(--hax-body-active-outline);
          }
        }
      `]}constructor(){super(),this.__ignoreActive=!1,this.__dragMoving=!1,this.___moveLock=!1,this.editMode=!1,this.haxMover=!1,this.activeNode=null,setTimeout(()=>{new Promise((res,rej)=>_require.default(["./lib/hax-text-context.js"],res,rej)),new Promise((res,rej)=>_require.default(["./lib/hax-ce-context.js"],res,rej)),new Promise((res,rej)=>_require.default(["./lib/hax-plate-context.js"],res,rej)),new Promise((res,rej)=>_require.default(["../grid-plate/grid-plate.js"],res,rej)),this.polyfillSafe=_haxStore.HAXStore.computePolyfillSafe(),this.addEventListener("place-holder-replace",this.replacePlaceholder.bind(this)),this.addEventListener("focusin",this._focusIn.bind(this)),this.addEventListener("mousemove",this._mouseMove.bind(this)),this.addEventListener("mouseleave",this._mouseLeave.bind(this)),this.addEventListener("touchstart",this._mouseMove.bind(this),{passive:!0}),this.addEventListener("mousedown",this._mouseDown.bind(this)),this.addEventListener("mouseup",this._mouseUp.bind(this)),this.addEventListener("dragenter",this.dragEnterBody.bind(this)),this.addEventListener("dragend",this.dragEndBody.bind(this)),this.addEventListener("drop",this.dropEvent.bind(this))},0),(0,_mobxEsm.autorun)(()=>{this.editMode=(0,_mobxEsm.toJS)(_haxStore.HAXStore.editMode)}),(0,_mobxEsm.autorun)(()=>{this.activeNode=(0,_mobxEsm.toJS)(_haxStore.HAXStore.activeNode)}),(0,_mobxEsm.autorun)(()=>{(0,_mobxEsm.toJS)(_haxStore.HAXStore.activeEditingElement)})}dragEndBody(e){this.__manageFakeEndCap(!1),_haxStore.HAXStore._lockContextPosition=!1,this.querySelectorAll(".hax-hovered").forEach(el=>{el.classList.remove("hax-hovered")})}_mouseLeave(e){this.editMode&&_haxStore.HAXStore.ready&&(clearTimeout(this.__mouseQuickTimer),clearTimeout(this.__mouseTimer),this.__activeHover=null,this._hideContextMenu(this.contextMenus.add))}_mouseMove(e){if(this.editMode&&_haxStore.HAXStore.ready){var eventPath=(0,_utils.normalizeEventPath)(e);clearTimeout(this.__mouseQuickTimer),this.__mouseQuickTimer=setTimeout(()=>{if(this.__activeHover&&this.__activeHover!=eventPath[0].closest("[data-hax-ray]:not(li)")&&!eventPath[0].closest("#addincontext")){let keep;for(var i=0;i<eventPath.length;i++)eventPath[i].getAttribute&&"addincontext"==eventPath[i].getAttribute("id")&&(keep=!0);keep||(this.__activeHover=null,this._hideContextMenu(this.contextMenus.add))}},300),clearTimeout(this.__mouseTimer),this.__mouseTimer=setTimeout(()=>{this.__addActiveVisible();let target=eventPath[0].closest("[data-hax-ray]:not(li)");if(target){this.__activeHover=target;let activeRect=this.__activeHover.getBoundingClientRect(),addRect=this.contextMenus.add.getBoundingClientRect(),distance=(e.pageY-(activeRect.top+window.scrollY))/activeRect.height,height=-addRect.height-1;distance>.3?(height=activeRect.height+1,this.__addAbove=!1):this.__addAbove=!0,this._positionContextMenu(this.contextMenus.add,this.__activeHover,activeRect.width/2-addRect.width/2,height)}else if(eventPath[0].closest(".column")&&eventPath[3]&&eventPath[3].closest("grid-plate")){let activeRect,posMenuEl,addRect=this.contextMenus.add.getBoundingClientRect(),height=-addRect.height-1;if(eventPath[0].closest(".column:not(.has-nodes")){if(this.__addAbove=!1,this.__slot=eventPath[0].closest(".column").getAttribute("id").replace("col","col-"),0==eventPath[0].closest(".column").parentNode.parentNode.host.children.length){let p=document.createElement("p");eventPath[0].closest(".column").parentNode.parentNode.host.appendChild(p)}this.__activeHover=eventPath[0].closest(".column").parentNode.parentNode.host.children[0],activeRect=eventPath[0].closest(".column").getBoundingClientRect(),height=activeRect.height/2-addRect.height/2,posMenuEl=eventPath[0].closest(".column")}else{this.__activeHover=eventPath[0].closest(".column").parentNode.parentNode.host,posMenuEl=this.__activeHover,activeRect=this.__activeHover.getBoundingClientRect(),(e.pageY-(activeRect.top+window.scrollY))/activeRect.height>.3?(height=activeRect.height+1,this.__addAbove=!1):this.__addAbove=!0}this._positionContextMenu(this.contextMenus.add,posMenuEl,activeRect.width/2-addRect.width/2,height)}else eventPath[0].closest("#bodycontainer")&&(this.__activeHover=null,this._hideContextMenu(this.contextMenus.add))},400)}}_mouseDown(e){if(this.editMode){this.__mouseDown=!0;let target=e.target;target.closest("[draggable]")?target=target.closest("[draggable]"):target.closest("[slot]")?target=target.closest("[slot]"):target.closest("[data-hax-ray]")?target=target.closest("[data-hax-ray]"):target.closest("[contenteditable]")?target=target.closest("[contenteditable]"):_haxStore.HAXStore.validTagList.includes(target.tagName.toLowerCase())||"HAX-BODY"!==target.tagName&&console.warn(target),!target.haxUIElement&&this.__focusLogic(target)&&(e.stopPropagation(),e.stopImmediatePropagation())}}_mouseUp(e){setTimeout(()=>{this.__mouseDown=!1},0),clearTimeout(gravityScrollTimer),this.__manageFakeEndCap(!1)}clickEvent(e){clearTimeout(gravityScrollTimer)}blurEvent(e){this.editMode&&_haxStore.HAXStore.activeEditingElement}__manageFakeEndCap(create=!0){if(create&&!this.__fakeEndCap){let fake=document.createElement("fake-hax-body-end");fake.style.width="100%",fake.style.height="20px",fake.style.zIndex="2",fake.style.display="block",this.__fakeEndCap=fake,this.haxMover=!0,this.appendChild(this.__fakeEndCap),this.__applyNodeEditableState(this.__fakeEndCap,!0)}else!create&&this.__fakeEndCap&&(this.__fakeEndCap.remove(),this.haxMover=!1,this.__fakeEndCap=null)}dragEnterBody(e){this.__manageFakeEndCap(!0)}render(){return _litElement.html`
      <div id="bodycontainer" class="ignore-activation">
        <slot id="body"></slot>
      </div>
      <hax-text-context
        id="textcontextmenu"
        class="hax-context-menu ignore-activation"
      ></hax-text-context>
      <hax-ce-context
        id="cecontextmenu"
        class="hax-context-menu ignore-activation"
      ></hax-ce-context>
      <hax-plate-context
        id="platecontextmenu"
        class="hax-context-menu ignore-activation"
      ></hax-plate-context>
      <hax-context-item
        id="addincontext"
        class="hax-context-menu ignore-activation"
        icon="icons:add-circle"
        label="Add here"
        mini
        circle
      >
      </hax-context-item>
    `}static get properties(){return{...super.properties,haxMover:{type:Boolean,attribute:"hax-mover",reflect:!0},editMode:{type:Boolean,reflect:!0,attribute:"edit-mode"},activeNode:{type:Object}}}firstUpdated(changedProperties){this.dispatchEvent(new CustomEvent("hax-register-body",{bubbles:!0,cancelable:!0,composed:!0,detail:this}));try{document.execCommand("enableObjectResizing",!1,!1),document.execCommand("defaultParagraphSeparator",!1,"p")}catch(e){console.warn(e)}this.contextMenus={text:this.shadowRoot.querySelector("#textcontextmenu"),plate:this.shadowRoot.querySelector("#platecontextmenu"),ce:this.shadowRoot.querySelector("#cecontextmenu"),add:this.shadowRoot.querySelector("#addincontext")},this.contextMenus.add.addEventListener("click",this._addInContextClick.bind(this)),this.shadowRoot.querySelector("slot").addEventListener("mouseup",e=>{this.editMode&&setTimeout(()=>{const tmp=_haxStore.HAXStore.getSelection();_haxStore.HAXStore._tmpSelection=tmp,_haxStore.HAXStore.haxSelectedText=tmp.toString();try{const range=_haxStore.HAXStore.getRange();range.cloneRange&&(_haxStore.HAXStore._tmpRange=range.cloneRange())}catch(e){console.warn(e)}},10)}),this.editMode=_haxStore.HAXStore.editMode,this.__tabTrap=!1,this.ready=!0,super.firstUpdated&&super.firstUpdated(changedProperties)}_addInContextClick(e){this.__mouseDown=!1;["ul","ol"].includes(this.__activeHover.parentNode.tagName.toLowerCase())&&(this.__activeHover=this.__activeHover.parentNode),this.haxInsert("p","",{},this.__activeHover),this.__activeHover=null,this._hideContextMenu(this.contextMenus.add)}updated(changedProperties){changedProperties.forEach((oldValue,propName)=>{"editMode"==propName&&void 0!==oldValue&&setTimeout(()=>{this._editModeChanged(this[propName],oldValue),this[propName]?(this._activeNodeChanged(this.activeNode,null),this.activeNode.focus()):this._activeNodeChanged(null,this.activeNode)},0),"activeNode"==propName&&this.ready&&this._activeNodeChanged(this[propName],oldValue)}),super.updated&&super.updated(changedProperties)}connectedCallback(){super.connectedCallback(),this._observer=new MutationObserver(mutations=>{var mutFind=!1;this.__ignoreActive||this.__dragMoving||this.undoStackIgnore||this.__fakeEndCap?this.undoStackIgnore?mutations.forEach(mutation=>{mutation.addedNodes.length>0&&mutation.addedNodes.forEach(node=>{this._validElementTest(node)&&setTimeout(()=>{this.__applyNodeEditableState(node,this.editMode)},0)})}):this.__ignoreActive&&(this.__ignoreActive=!1):mutations.forEach(mutation=>{if(mutation.addedNodes.length>0){for(var node of mutation.addedNodes)if(this._validElementTest(node)){if(!this.__delHit&&"BR"===node.tagName&&node.parentElement&&_haxStore.HAXStore.__validGridTags().includes(node.parentElement.tagName.toLowerCase())&&node===node.parentElement.childNodes[node.parentElement.childNodes.length-1]){let p=node.parentElement;if(node.remove(),p.childNodes.length>0){let txt=p.childNodes[p.childNodes.length-1];txt.textContent+="​",_haxStore.HAXStore._positionCursorInNode(txt,txt.length)}continue}if(this.__delHit=!1,"P"===node.tagName&&node.children.length>0&&"P"===node.children[0].tagName){(0,_utils.unwrap)(node);continue}if("P"===node.tagName&&node.parentElement&&"P"===node.parentElement.tagName){(0,_utils.unwrap)(node.parentElement);continue}if(null!=node.getAttribute("slot")&&node.parentElement===this){node.removeAttribute("slot");continue}if("LI"===node.tagName&&node.children.length>0&&"SPAN"===node.children[0].tagName){this.activeNode!==node.children[0]&&this.activeNode!==node||(this.activeNode=node),(0,_utils.unwrap)(node.children[0]);continue}if("LI"===node.tagName&&node.parentElement&&!["UL","OL"].includes(node.parentElement.tagName)){(0,_utils.unwrap)(node);continue}if("P"===node.tagName&&node.children.length>0&&["P","LI"].includes(node.children[0].tagName)){(0,_utils.unwrap)(node.children[0]);continue}if(this.__slot&&(node.setAttribute("slot",this.__slot),this.__slot=null),this.__indentTrap)if("SPAN"===node.tagName)node.parentNode===this?this.haxChangeTagName(node,"p",!0):"LI"===node.parentNode.tagName&&(node.parentNode.innerHTML=node.textContent);else if("BR"===node.tagName){node.remove();continue}if(!this.editMode||"true"!=node.getAttribute("contenteditable")&&!0!==node.getAttribute("contenteditable")&&"contenteditable"!=node.getAttribute("contenteditable")||this.__applyNodeEditableState(node,!this.editMode),this.__applyNodeEditableState(node,this.editMode),_haxStore.HAXStore.isGridPlateElement(node)){let grandKids=node.querySelectorAll("*");for(var j=0;j<grandKids.length;j++)this._validElementTest(grandKids[j])&&this.__applyNodeEditableState(grandKids[j],this.editMode)}if(["H1","H2","H3","H4","H5","H6"].includes(node.tagName)&&null==node.getAttribute("id")&&node.setAttribute("id",(0,_utils.generateResourceID)("header-")),this.___moveLock||mutFind)this.___moveLock=!1;else if(mutFind=!0,_haxStore.HAXStore.activeNode=node,"BR"===node.tagName){const tmp=_haxStore.HAXStore.getSelection();_haxStore.HAXStore._tmpSelection=tmp,_haxStore.HAXStore.haxSelectedText=tmp.toString();const rng=_haxStore.HAXStore.getRange();rng.collapsed&&"BR"===this.activeNode.tagName&&this.activeNode.parentNode===rng.commonAncestorContainer&&""===this.activeNode.innerText&&(_haxStore.HAXStore.activeNode=this.activeNode.parentNode)}}this.__indentTrap&&setTimeout(()=>{this.__indentTrap=!1},0)}})}),this._observer.observe(this,{childList:!0,subtree:!0}),window.addEventListener("hax-context-item-selected",this._haxContextOperation.bind(this)),window.addEventListener("click",this.clickEvent.bind(this)),window.addEventListener("blur",this.blurEvent.bind(this)),window.addEventListener("keydown",this._onKeyDown.bind(this)),window.addEventListener("keypress",this._onKeyPress.bind(this)),document.body.addEventListener("hax-store-property-updated",this._haxStorePropertyUpdated.bind(this)),window.addEventListener("scroll",this._keepContextVisible.bind(this),{passive:!0}),window.addEventListener("resize",this._keepContextVisible.bind(this),{passive:!0})}disconnectedCallback(){window.removeEventListener("click",this.clickEvent.bind(this)),window.removeEventListener("blur",this.blurEvent.bind(this)),window.removeEventListener("keydown",this._onKeyDown.bind(this)),window.removeEventListener("keypress",this._onKeyPress.bind(this)),document.body.removeEventListener("hax-store-property-updated",this._haxStorePropertyUpdated.bind(this)),window.removeEventListener("scroll",this._keepContextVisible.bind(this)),window.removeEventListener("resize",this._keepContextVisible.bind(this)),window.removeEventListener("hax-context-item-selected",this._haxContextOperation.bind(this)),this._observer.disconnect(),super.disconnectedCallback()}_keepContextVisible(e=null){this.editMode&&(clearTimeout(this.__contextVisibleLock),this.__contextVisibleLock=setTimeout(()=>{let el=!1;this.contextMenus.text.classList.contains("hax-context-visible")?el=this.contextMenus.text:this.contextMenus.ce.classList.contains("hax-context-visible")&&(el=this.contextMenus.ce),el&&(this.activeNode&&this.elementMidViewport()?(el.classList.add("hax-context-pin-top"),this.contextMenus.plate.classList.add("hax-context-pin-top")):(el.classList.remove("hax-context-pin-top"),this.contextMenus.plate.classList.remove("hax-context-pin-top")),this.positionContextMenus())},100))}_onKeyDown(e){if(this.editMode&&"HAX-TRAY"!==document.activeElement.tagName&&"BODY"!==document.activeElement.tagName&&"SIMPLE-MODAL"!==document.activeElement.tagName&&this.getAttribute("contenteditable")){if(this.__dropActiveVisible(),this.__manageFakeEndCap(!1),null!=_haxStore.HAXStore.getSelection().anchorNode)switch(e.key){case"Z":case"z":e.ctrlKey&&(e.shiftKey?this.redo():this.undo(),e.detail.keyboardEvent&&(e.detail.keyboardEvent.preventDefault(),e.detail.keyboardEvent.stopPropagation(),e.detail.keyboardEvent.stopImmediatePropagation()),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation());break;case"Tab":_haxStore.HAXStore.isTextElement(this.activeNode)&&(e.detail.keyboardEvent&&(e.detail.keyboardEvent.preventDefault(),e.detail.keyboardEvent.stopPropagation(),e.detail.keyboardEvent.stopImmediatePropagation()),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),e.shiftKey?this._tabBackKeyPressed():this._tabKeyPressed());break;case"Enter":if(this.activeNode&&(this.__slot=this.activeNode.getAttribute("slot")),this.activeNode&&"P"===this.activeNode.tagName&&["1","#","`",">","-","!"].includes(this.activeNode.textContent[0])){const guess=this.activeNode.textContent.replaceAll(/ /g," ");this.keyboardShortCutProcess(guess)}break;case"Backspace":case"Delete":this.__delHit=!0;break;case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":setTimeout(()=>{const tmp=_haxStore.HAXStore.getSelection();_haxStore.HAXStore._tmpSelection=tmp,_haxStore.HAXStore.haxSelectedText=tmp.toString();const rng=_haxStore.HAXStore.getRange();rng.commonAncestorContainer&&this.activeNode!==rng.commonAncestorContainer&&"function"==typeof rng.commonAncestorContainer.focus?"HAX-BODY"!==rng.commonAncestorContainer.tagName&&this.__focusLogic(rng.commonAncestorContainer,!1):rng.commonAncestorContainer&&rng.commonAncestorContainer.parentNode&&this.activeNode!==rng.commonAncestorContainer.parentNode&&"function"==typeof rng.commonAncestorContainer.parentNode.focus&&("HAX-BODY"!==rng.commonAncestorContainer.parentNode.tagName?this.__focusLogic(rng.commonAncestorContainer.parentNode,!1):this.__focusLogic(rng.commonAncestorContainer,!1))},0);break;default:setTimeout(()=>{if(this.activeNode&&"P"===this.activeNode.tagName&&["1","#","`",">","-","!"].includes(this.activeNode.textContent[0])){const guess=this.activeNode.textContent.replaceAll(/ /g," ");" "===guess[guess.length-1]&&this.keyboardShortCutProcess(guess)}},0)}}}keyboardShortCutProcess(guess){if(_haxStore.HAXStore.keyboardShortcuts[guess.replace(" ","")]){let el=(0,_utils.haxElementToNode)(_haxStore.HAXStore.keyboardShortcuts[guess.replace(" ","")]);this.haxReplaceNode(this.activeNode,el),this.__focusLogic(el),"HR"===el.tagName&&this.haxInsert("p","",{})}else if("!"===guess[0]){let tag=guess.replace("!","").replaceAll(/ /g,"");if(_haxStore.HAXStore.elementList[tag]){let target,schema=_haxStore.HAXStore.haxSchemaFromTag(tag);target=schema.gizmo.tag&&schema.demoSchema&&schema.demoSchema[0]?(0,_utils.haxElementToNode)(schema.demoSchema[0]):document.createElement(tag),this.haxReplaceNode(this.activeNode,target),this.__focusLogic(target)}else _haxStore.HAXStore.toast(`${tag} is not a valid tag`)}}_onKeyPress(e){clearTimeout(this.__keyPress),this.__keyPress=setTimeout(()=>{this.editMode&&this.activeNode&&_haxStore.HAXStore.isTextElement(this.activeNode)&&("Enter"===e.key&&(this.activeNode=this.activeNode.nextElementSibling),clearTimeout(this.__positionContextTimer),this.__positionContextTimer=setTimeout(()=>{this.__addActiveVisible(),this.positionContextMenus()},2500))},50)}elementMidViewport(){const y=this.activeNode.getBoundingClientRect().y;return y<0&&y>-1*this.activeNode.offsetHeight+140}replacePlaceholder(e){if("text"===e.detail){let p=document.createElement("p");this.haxReplaceNode(this.activeNode,p),this.__focusLogic(p),this.activeNode.parentNode&&this.activeNode.parentNode.setAttribute("contenteditable",!0)}else this.replaceElementWorkflow()}canTansformNode(node=null){return this.replaceElementWorkflow(node,!0).length>0}replaceElementWorkflow(activeNode=null,testOnly=!1){null==activeNode&&(activeNode=this.activeNode);let element=(0,_utils.nodeToHaxElement)(activeNode,null),type="*",skipPropMatch=!1;"place-holder"===element.tag&&void 0!==element.properties.type&&(type=element.properties.type,skipPropMatch=!0);var props={};if(void 0!==_haxStore.HAXStore.elementList[element.tag]&&!1!==_haxStore.HAXStore.elementList[element.tag].gizmo&&void 0!==_haxStore.HAXStore.elementList[element.tag].gizmo.handles&&_haxStore.HAXStore.elementList[element.tag].gizmo.handles.length>0){let gizmo=_haxStore.HAXStore.elementList[element.tag].gizmo;for(var i=0;i<gizmo.handles.length;i++)for(var prop in gizmo.handles[i])"type"!==prop&&void 0!==element.properties[gizmo.handles[i][prop]]&&(props[prop]=element.properties[gizmo.handles[i][prop]])}let haxElements=_haxStore.HAXStore.guessGizmo(type,props,skipPropMatch);if(haxElements.length>0){let tag=activeNode.tagName.toLowerCase(),humanName=tag.replace("-"," ");void 0!==_haxStore.HAXStore.elementList[tag]&&!1!==_haxStore.HAXStore.elementList[tag].gizmo&&(humanName=_haxStore.HAXStore.elementList[tag].gizmo.title),testOnly||(_haxStore.HAXStore.activePlaceHolder=this.activeNode,_haxStore.HAXStore.haxAppPicker.presentOptions(haxElements,"__convert",`Transform ${humanName} to..`,"gizmo"))}else testOnly||_haxStore.HAXStore.toast("Sorry, this can not be transformed!",5e3);return haxElements}_haxStorePropertyUpdated(e){e.detail&&void 0!==e.detail.value&&e.detail.property&&(this[e.detail.property]=e.detail.value)}haxClearBody(confirm=!0){let status=!0;confirm&&(status=prompt("Are you sure you want to delete all content?")),status&&(0,_utils.wipeSlot)(this)}haxInsert(tag,content,properties={},active=this.activeNode){var frag=document.createElement(tag);frag.innerHTML=content;const newNode=frag.cloneNode(!0);for(var property in properties){let attributeName=(0,_utils.camelToDash)(property);properties.hasOwnProperty(property)&&(!0===properties[property]?newNode.setAttribute(attributeName,attributeName):!1===properties[property]?newNode.removeAttribute(attributeName):null!=properties[property]&&properties[property].constructor===Array||null!=properties[property]&&properties[property].constructor===Object?newNode.properties&&newNode.properties[property].readOnly||(newNode.set?newNode.set(attributeName,properties[property]):newNode[attributeName]=properties[property]):newNode.setAttribute(attributeName,properties[property]))}return null!==_haxStore.HAXStore.activePlaceHolder&&void 0!==_haxStore.HAXStore.activePlaceHolder.style?(newNode.style.width=_haxStore.HAXStore.activePlaceHolder.style.width,newNode.style.float=_haxStore.HAXStore.activePlaceHolder.style.float,newNode.style.margin=_haxStore.HAXStore.activePlaceHolder.style.margin,newNode.style.display=_haxStore.HAXStore.activePlaceHolder.style.display,this.haxReplaceNode(_haxStore.HAXStore.activePlaceHolder,newNode),_haxStore.HAXStore.activePlaceHolder=null):active&&active.parentNode?"GRID-PLATE"===active.parentNode.tagName?(null!=active.getAttribute("slot")&&newNode.setAttribute("slot",active.getAttribute("slot")),this.__addAbove?active.parentNode.insertBefore(newNode,active):active.parentNode.insertBefore(newNode,active.nextElementSibling)):active.parentNode&&active.parentNode.nextElementSibling?active.parentNode.nextElementSibling.parentNode.insertBefore(newNode,active.parentNode.nextElementSibling):active.parentNode&&active.nextElementSibling?this.__addAbove?active.parentNode.insertBefore(newNode,active):active.parentNode.insertBefore(newNode,active.nextElementSibling):active.parentNode&&active.parentNode.children[active.parentNode.children.length-1]===active?this.__addAbove?active.parentNode.insertBefore(newNode,active):active.parentNode.appendChild(newNode):active.parentNode?active.parentNode.insertBefore(newNode,active):this.appendChild(newNode):this.appendChild(newNode),this.contextMenus.text.hasSelectedText=!1,setTimeout(()=>{this.__focusLogic(newNode),this.scrollHere(newNode)},0),newNode}haxToContent(){this.hideContextMenus();var __active=this.activeNode;_haxStore.HAXStore.activeNode=null;let children="slot"===this.shadowRoot.querySelector("#body").localName?this.shadowRoot.querySelector("#body").assignedNodes({flatten:!0}):[];for(var content="",i=0;i<children.length;i++)if(this._validElementTest(children[i]))children[i].removeAttribute("data-hax-ray"),children[i].classList.remove("hax-hovered"),children[i].contentEditable=!1,content+=_haxStore.HAXStore.nodeToContent(children[i]),"grid-plate"===children[i].tagName.toLowerCase()&&this._applyContentEditable(this.editMode,children[i]);else if(8===children[i].nodeType)content+="\x3c!-- "+children[i].textContent+" --\x3e";else if(children[i].haxUIElement&&children[i].children&&children[i].children[0]){let tmp=_haxStore.HAXStore.runHook(children[i],"activeElementChanged",[this.activeNode,!1]);tmp&&tmp!==children[i]?content+=_haxStore.HAXStore.nodeToContent(tmp):content+=_haxStore.HAXStore.nodeToContent(children[i].children[0])}else 1!==children[i].nodeType&&void 0!==children[i].textContent&&"undefined"!==children[i].textContent&&(content+=children[i].textContent);if(content=(content=(content=(content=content.replace(/\scontenteditable=\"false\"/g,"")).replace(/\scontenteditable/g,"")).replace(/\sdraggable/g,"")).replace(/\sdata-hax-ray=\".*?\"/g,""),this.parentNode.tagName){let parentTag=this.parentNode.tagName.toLowerCase(),string="style-scope "+parentTag+" x-scope",re=new RegExp(string,"g");content=content.replace(re,""),string="style-scope "+parentTag,re=new RegExp(string,"g"),content=content.replace(re,""),string="x-scope "+parentTag+"-0",re=new RegExp(string,"g"),content=content.replace(re,"");let tags=_haxStore.HAXStore.validTagList;for(var i in tags)string="style-scope "+tags[i],re=new RegExp(string,"g"),content=content.replace(re,""),string="x-scope "+tags[i]+"-0 ",re=new RegExp(string,"g"),content=content.replace(re,""),string="x-scope "+tags[i]+"-0",re=new RegExp(string,"g"),content=content.replace(re,"")}return content=(content=content.replace(/\sclass=\"\"/g,"")).replace(/\sclass=\"\s\"/g,""),this._applyContentEditable(this.editMode),_haxStore.HAXStore.activeNode=__active,content=(0,_utils.encapScript)(content)}haxDuplicateNode(node){let haxElement=(0,_utils.nodeToHaxElement)(node,null);var props=_haxStore.HAXStore.elementList[node.tagName.toLowerCase()];if(void 0!==props&&void 0!==props.saveOptions.unsetAttributes)for(var i in props.saveOptions.unsetAttributes)haxElement.properties[props.saveOptions.unsetAttributes[i]]&&delete haxElement.properties[props.saveOptions.unsetAttributes[i]];_haxStore.HAXStore.testHook(node,"preProcessInsertContent")&&(haxElement=_haxStore.HAXStore.runHook(node,"preProcessInsertContent",[haxElement])),haxElement.content==haxElement.properties.innerHTML&&delete haxElement.properties.innerHTML;var nodeClone=(0,_utils.haxElementToNode)({tag:haxElement.tag,content:haxElement.content,properties:haxElement.properties});return"webview"===nodeClone.tagName.toLowerCase()&&_haxStore.HAXStore._isSandboxed&&void 0!==nodeClone.guestinstance&&delete nodeClone.guestinstance,null!==node?node.parentNode.insertBefore(nodeClone,node.nextSibling):node.parentNode.appendChild(nodeClone),_haxStore.HAXStore.activeNode=nodeClone,!0}hideContextMenus(hidePlate=!0){clearTimeout(gravityScrollTimer),clearTimeout(this.__keyPress),clearTimeout(this.__contextVisibleLock),clearTimeout(this.__positionContextTimer),this._hideContextMenu(this.contextMenus.text),this._hideContextMenu(this.contextMenus.ce),this._hideContextMenu(this.contextMenus.add),this.__activeHover=null,hidePlate&&this._hideContextMenu(this.contextMenus.plate)}positionContextMenus(node=this.activeNode){if(node&&node.tagName&&this.ready){let tag=node.tagName.toLowerCase();_haxStore.HAXStore.elementList&&_haxStore.HAXStore.elementList[tag]&&_haxStore.HAXStore.elementList[tag].contentEditable?node.setAttribute("contenteditable",!0):node.removeAttribute("contenteditable"),clearTimeout(this.__positionContextTimer),this.__positionContextTimer=setTimeout(()=>{if(!_haxStore.HAXStore._lockContextPosition){let menuWidth=140,tag=node.tagName.toLowerCase();_haxStore.HAXStore._isSandboxed&&"webview"===tag&&(tag="iframe");let props=_haxStore.HAXStore.elementList[tag];if(void 0===props||_haxStore.HAXStore.isTextElement(node)){this._hideContextMenu(this.contextMenus.ce),this._positionContextMenu(this.contextMenus.text,node,0,-28),menuWidth+=this.contextMenus.text.getBoundingClientRect().width}else this._hideContextMenu(this.contextMenus.text),props.element=node,"core"==props.editingElement?this._positionContextMenu(this.contextMenus.ce,node,0,-28):this._hideContextMenu(this.contextMenus.ce),menuWidth+=28;if(props&&"core"!=props.editingElement)setTimeout(()=>{if(node&&node.parentNode){let activeRect=node.parentNode.getBoundingClientRect();this._positionContextMenu(this.contextMenus.plate,node.parentNode,activeRect.width-this.contextMenus.plate.getBoundingClientRect().width+1,-26)}},250);else{let activeRect=node.getBoundingClientRect();this.activeNode&&("LI"===this.activeNode.tagName||this._HTMLInlineTextDecorationTest(this.activeNode))?this._hideContextMenu(this.contextMenus.plate):Math.round(menuWidth)>=Math.round(activeRect.width)?this._positionContextMenu(this.contextMenus.plate,node,0,-56):this._positionContextMenu(this.contextMenus.plate,node,activeRect.width-this.contextMenus.plate.getBoundingClientRect().width+1,-26)}}},50)}}__addActiveVisible(){for(var i in this.contextMenus)("add"!=i||this.__activeHover)&&this.contextMenus[i].classList.add("hax-context-menu-active")}__dropActiveVisible(){for(var i in this.contextMenus)this.contextMenus[i].classList.remove("hax-context-menu-active");this.__activeHover=null,this._hideContextMenu(this.contextMenus.add)}haxMoveGridPlate(direction,node){switch(this.___moveLock=!0,direction){case"up":null!==node.previousElementSibling&&node.parentNode.insertBefore(node,node.previousElementSibling);break;case"down":null!==node.nextElementSibling&&node.parentNode.insertBefore(node.nextElementSibling,node)}return this.scrollHere(node),this.positionContextMenus(node),!0}async haxGridPlateOps(add=!0,side="right",node=this.activeNode){let changed=!1;if("GRID-PLATE"===node.tagName){if(add)switch(node.layout){case"1":node.layout="1-1",changed=!0;break;case"1-1":node.layout="1-1-1",changed=!0;break;case"1-1-1":node.layout="1-1-1-1",changed=!0;break;case"1-1-1-1":node.layout="1-1-1-1-1",changed=!0;break;case"1-1-1-1-1":node.layout="1-1-1-1-1-1",changed=!0}else switch(node.layout){case"1-1":let cloneEl;await node.childNodes.forEach(el=>{el.tagName&&(cloneEl=el.cloneNode(!0),node.getAttribute("slot")?cloneEl.setAttribute("slot",node.getAttribute("slot")):cloneEl.removeAttribute("slot"),node.parentNode.insertBefore(cloneEl,node))}),_haxStore.HAXStore.activeNode=cloneEl,setTimeout(()=>{node.remove()},0),changed=!0;break;case"1-1-1":node.layout="1-1",changed=!0;break;case"1-1-1-1":node.layout="1-1-1",changed=!0;break;case"1-1-1-1-1":node.layout="1-1-1-1",changed=!0;break;case"1-1-1-1-1-1":node.layout="1-1-1-1-1",changed=!0}if(changed){let right=this.contextMenus.plate.shadowRoot.querySelector("#right"),rightremove=this.contextMenus.plate.shadowRoot.querySelector("#rightremove");right.disabled=!1,rightremove.disabled=!1,"1-1-1-1-1-1"==node.layout&&(right.disabled=!0),"left"==side&&node.childNodes.forEach(el=>{if(el.tagName){let s=parseInt(el.getAttribute("slot").replace("col-",""),10)+1;el.setAttribute("slot",`col-${s}`)}})}}else{let grid=document.createElement("grid-plate");grid.layout="1-1",grid.disableResponsive=!0,node.getAttribute("slot")&&grid.setAttribute("slot",node.getAttribute("slot"));let col="2";"right"==side&&(col="1");let tmp=node.cloneNode(!0);tmp.setAttribute("slot","col-"+col),grid.appendChild(tmp),node.parentNode.insertBefore(grid,node),setTimeout(()=>{node.remove()},0)}_haxStore.HAXStore.refreshActiveNodeForm()}haxReplaceNode(node,replacement){try{null==node&&(node=this.__oldActiveNode),!node.replaceWith&&_haxStore.HAXStore._tmpRange&&(node=_haxStore.HAXStore._tmpRange,_haxStore.HAXStore._tmpRange=null),node&&node.getAttribute&&null!=node.getAttribute("slot")&&replacement.setAttribute("slot",node.getAttribute("slot")),node.replaceWith(replacement)}catch(e){console.warn(e)}return replacement}haxChangeTagName(node,tagName,maintainContent=!0){for(var replacement=document.createElement(tagName),i=0,l=node.attributes.length;i<l;++i){let nodeName=node.attributes.item(i).nodeName,value=node.attributes.item(i).value;try{replacement.setAttribute(nodeName,value)}catch(e){console.warn(node.attributes),console.warn(e)}}maintainContent&&(replacement.innerHTML=node.innerHTML.trim()),"ul"==tagName||"ol"==tagName?"<br />"==replacement.innerHTML?replacement.innerHTML="<li><br /></li>":"ul"!=node.tagName.toLowerCase()&&"ol"!=node.tagName.toLowerCase()&&(replacement.innerHTML="<li>"+node.innerHTML.trim().replace(/<br\/>/g,"</li>\n<li>").replace(/<br>/g,"</li>\n<li>")+"</li>"):"ul"!=node.tagName.toLowerCase()&&"ol"!=node.tagName.toLowerCase()||(replacement.innerHTML=replacement.innerHTML.replace(/<ul>/g,"").replace(/<\/ul>/g,"").replace(/<li><\/li>/g,"").replace(/<li>/g,"").replace(/<\/li>/g,"<br/>"));try{node.replaceWith(replacement),maintainContent&&setTimeout(()=>{let children=replacement.children;children[0]&&children.tagName?children[0].focus():replacement.focus()},10)}catch(e){console.warn(e),console.warn(replacement),console.warn(node)}return replacement}haxDeleteNode(node){if(node.previousElementSibling)_haxStore.HAXStore.activeNode=node.previousElementSibling;else if(node.nextElementSibling)_haxStore.HAXStore.activeNode=node.nextElementSibling;else{this.haxInsert("p","",{});try{var range=document.createRange(),sel=_haxStore.HAXStore.getSelection();range.setStart(this.activeNode,0),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range),this.activeNode.focus()}catch(e){console.warn(e)}}try{return node.remove()}catch(e){console.warn(e)}}importContent(html,clear=!0){clear&&(0,_utils.wipeSlot)(this,"*"),setTimeout(()=>{html=(0,_utils.encapScript)(html);let fragment=document.createElement("div");for(fragment.insertAdjacentHTML("beforeend",html);null!==fragment.firstChild;)if(void 0!==fragment.firstChild.tagName)if(_haxStore.HAXStore._isSandboxed&&"iframe"===fragment.firstChild.tagName.toLowerCase()){for(var replacement=document.createElement("webview"),j=0,l=fragment.firstChild.attributes.length;j<l;++j){var nodeName=fragment.firstChild.attributes.item(j).nodeName,value=fragment.firstChild.attributes.item(j).value;"height"!==nodeName&&"width"!==nodeName||replacement.style[nodeName],replacement.setAttribute(nodeName,value)}this.appendChild(replacement)}else this.appendChild(fragment.firstChild);else fragment.removeChild(fragment.firstChild)},0)}_haxContextOperation(e){let detail=e.detail;switch(detail.eventName){case"insert-above-active":if(this.activeNode&&this.activeNode.previousElementSibling)this.haxInsert("p","",{},this.activeNode.previousElementSibling);else{let p=document.createElement("p");this.insertBefore(p,this.childNodes[0])}break;case"insert-below-active":this.haxInsert("p","",{});break;case"hax-source-view-toggle":if(this.activeNode.__haxSourceView){this.activeNode.__haxSourceView=!1;let replacement=_haxStore.HAXStore.runHook(_haxStore.HAXStore.activeEditingElement,"activeElementChanged",[this.activeNode,!1]),oldSchema=_haxStore.HAXStore.haxSchemaFromTag(this.activeNode.tagName.toLowerCase());if(this.activeNode&&this.activeNode.getAttribute&&null!=this.activeNode.getAttribute("slot")&&replacement.setAttribute("slot",this.activeNode.getAttribute("slot")),oldSchema.saveOptions&&oldSchema.saveOptions.unsetAttributes&&oldSchema.saveOptions.unsetAttributes.length)for(var i in oldSchema.saveOptions.unsetAttributes)replacement.removeAttribute(oldSchema.saveOptions.unsetAttributes[i]);this.__applyNodeEditableState(replacement,this.editMode),(0,_utils.unwrap)(_haxStore.HAXStore.activeEditingElement),_haxStore.HAXStore.activeEditingElement=null}else this.activeNode.__haxSourceView=!0,_haxStore.HAXStore.activeEditingElement=document.createElement("code-editor"),_haxStore.HAXStore.activeEditingElement.language="html",_haxStore.HAXStore.activeEditingElement.title="",_haxStore.HAXStore.activeEditingElement.theme="vs",_haxStore.HAXStore.activeEditingElement.fontSize=12,_haxStore.HAXStore.activeEditingElement.wordWrap=!0,new Promise((res,rej)=>_require.default(["../code-editor/code-editor.js"],res,rej)),this.activeNode.getAttribute&&null!=this.activeNode.getAttribute("slot")&&_haxStore.HAXStore.activeEditingElement.setAttribute("slot",this.activeNode.getAttribute("slot")),this.__ignoreActive=!0,this.activeNode.removeAttribute("contenteditable"),this.activeNode.removeAttribute("data-hax-ray"),this.activeNode.classList.remove("hax-active"),(0,_utils.wrap)(this.activeNode,_haxStore.HAXStore.activeEditingElement);break;case"hax-full-text-editor-toggle":if(this.activeNode.__haxSourceView){this.activeNode.__haxSourceView=!1;let replacement=_haxStore.HAXStore.runHook(_haxStore.HAXStore.activeEditingElement,"activeElementChanged",[this.activeNode,!1]),oldSchema=_haxStore.HAXStore.haxSchemaFromTag(this.activeNode.tagName.toLowerCase());if(this.activeNode&&this.activeNode.getAttribute&&null!=this.activeNode.getAttribute("slot")&&replacement.setAttribute("slot",this.activeNode.getAttribute("slot")),oldSchema.saveOptions&&oldSchema.saveOptions.unsetAttributes&&oldSchema.saveOptions.unsetAttributes.length)for(var i in oldSchema.saveOptions.unsetAttributes)replacement.removeAttribute(oldSchema.saveOptions.unsetAttributes[i]);this.__applyNodeEditableState(replacement,this.editMode),(0,_utils.unwrap)(_haxStore.HAXStore.activeEditingElement),_haxStore.HAXStore.activeEditingElement=null}else this.activeNode.__haxSourceView=!0,new Promise((res,rej)=>_require.default(["../rich-text-editor/rich-text-editor.js"],res,rej)).then(()=>{_haxStore.HAXStore.activeEditingElement=document.createElement("rich-text-editor"),_haxStore.HAXStore.activeEditingElement.type="rich-text-editor-toolbar-full",this.activeNode.getAttribute&&null!=this.activeNode.getAttribute("slot")&&_haxStore.HAXStore.activeEditingElement.setAttribute("slot",this.activeNode.getAttribute("slot")),this.__ignoreActive=!0,this.activeNode.removeAttribute("contenteditable"),this.activeNode.removeAttribute("data-hax-ray"),this.activeNode.classList.remove("hax-active"),(0,_utils.wrap)(this.activeNode,_haxStore.HAXStore.activeEditingElement)});break;case"text-tag":_haxStore.HAXStore.activeNode=this.haxChangeTagName(this.activeNode,detail.value),this.positionContextMenus();break;case"text-tag-ul":this.contextMenus.text.realSelectedValue="ul",_haxStore.HAXStore.activeNode=this.haxChangeTagName(this.activeNode,"ul"),this.positionContextMenus();break;case"text-tag-ol":this.contextMenus.text.realSelectedValue="ol",_haxStore.HAXStore.activeNode=this.haxChangeTagName(this.activeNode,"ol"),this.positionContextMenus();break;case"text-align-left":this.activeNode.style.textAlign=null;break;case"hax-transform-node":this.replaceElementWorkflow();break;case"hax-plate-create-right":this.haxGridPlateOps();break;case"hax-plate-remove-right":this.haxGridPlateOps(!1);break;case"hax-plate-duplicate":this.haxDuplicateNode(this.activeNode);break;case"hax-plate-delete":null!=this.activeNode&&this.haxDeleteNode(this.activeNode);break;case"hax-plate-up":this.haxMoveGridPlate("up",this.activeNode);break;case"hax-plate-down":this.haxMoveGridPlate("down",this.activeNode)}}_focusIn(e){this.__mouseDown||this.__focusLogic(e.target)&&(e.stopPropagation(),e.stopImmediatePropagation())}__focusLogic(target,autoFocus=!0){let stopProp=!1;if(this.editMode&&!this.__tabTrap){let containerNode=target;"SPAN"===containerNode.tagName&&_haxStore.HAXStore.isTextElement(containerNode.parentNode)&&""==containerNode.parentNode.getAttribute("slot")&&(containerNode=target.parentNode);let activeNode=null;if(this._validElementTest(containerNode)&&containerNode.parentNode&&containerNode.parentNode.tagName){if("P"===containerNode.parentNode.tagName&&""==containerNode.parentNode.getAttribute("slot"))activeNode=containerNode,stopProp=!0;else{for(;containerNode.parentNode&&containerNode.parentNode.tagName&&"HAX-BODY"!=containerNode.parentNode.tagName;)null===activeNode&&"B"!==containerNode.tagName&&"I"!==containerNode.tagName&&"STRONG"!==containerNode.tagName&&"EM"!==containerNode.tagName&&(activeNode=containerNode),containerNode=containerNode.parentNode;null===activeNode?activeNode=containerNode:_haxStore.HAXStore.isGridPlateElement(containerNode)||(activeNode=containerNode)}(this.activeNode&&this.activeNode.parentNode!==containerNode&&!containerNode.classList.contains("ignore-activation")||containerNode.haxUIElement||containerNode.classList.contains("ignore-activation"))&&(stopProp=!0),activeNode.haxUIElement||activeNode.classList.contains("ignore-activation")||(_haxStore.HAXStore.activeNode=activeNode,setTimeout(()=>{if(autoFocus&&!this.__mouseDown&&_haxStore.HAXStore.isTextElement(activeNode))try{var range=document.createRange(),sel=_haxStore.HAXStore.getSelection();range.setStart(this.activeNode,0),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range),this.activeNode.focus()}catch(e){console.warn(e)}this.positionContextMenus(activeNode)},0),stopProp=!0)}}else this.__tabTrap=!1;return stopProp}scrollHere(node){setTimeout(()=>{"function"==typeof node.scrollIntoViewIfNeeded?node.scrollIntoViewIfNeeded(!0):node.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"})},0)}undo(){super.undo(),setTimeout(()=>{let active=this.querySelector(".hax-active");active?(this.__focusLogic(active),this.scrollHere(active)):this.hideContextMenus()},0)}redo(){super.redo(),setTimeout(()=>{let active=this.querySelector(".hax-active");active?(this.__focusLogic(active),this.scrollHere(active)):this.hideContextMenus()},0)}_editModeChanged(newValue,oldValue){if(void 0!==oldValue){if(this._applyContentEditable(newValue),newValue)if(this.children&&this.children[0]&&this.children[0].focus)this.__focusLogic(this.children[0]);else{this.haxInsert("p","",{});try{var range=document.createRange(),sel=_haxStore.HAXStore.getSelection();range.setStart(this.activeNode,0),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range),this.activeNode.focus()}catch(e){console.warn(e)}}setTimeout(()=>{this.undoStack.undoStackLimit=50,this.undoStack.undoStackPosition=-1,this.undoStack.commands=[],this.undoStack.changed(),this.undoStackInitialValue=this.innerHTML,this.undoStackPrevValue=this.undoStackInitialValue},0)}if(0==newValue){(0,_utils.unwrap)(_haxStore.HAXStore.activeEditingElement),_haxStore.HAXStore.activeEditingElement=null,this.removeAttribute("contenteditable"),this.hideContextMenus();let activeKids=this.querySelectorAll("[contenteditable],.hax-active");for(var i=0;i<activeKids.length;i++){let el=activeKids[i];el.removeAttribute("contenteditable"),el.classList.remove("hax-active")}}let children="slot"===this.shadowRoot.querySelector("#body").localName?this.shadowRoot.querySelector("#body").assignedNodes({flatten:!0}):[];0===children.length&&(children=this.shadowRoot.querySelector("#body").children);for(i=0;i<children.length;i++)_haxStore.HAXStore.runHook(children[i],"editModeChanged",[newValue])}_haxResolvePreviousElement(node){for(node=node.previousElementSibling;null!=node&&void 0!==node.tagName&&"HAX-"===node.tagName.substring(0,4);)node=node.previousElementSibling;return node}_validElementTest(node){return!(node.haxUIElement||!node.tagName||["TEMPLATE","HAX-BODY","HAX-APP-SEARCH-RESULT","FAKE-HAX-BODY-END"].includes(node.tagName))&&(!this._HTMLInlineTextDecorationTest(node)||"HAX-BODY"==node.parentNode)}_HTMLInlineTextDecorationTest(node){return["span","b","strong","i","em"].includes(node.tagName.toLowerCase())}_HTMLPrimativeTest(node){return null!=node&&void 0!==node.tagName&&-1==node.tagName.indexOf("-")}_applyContentEditable(status,target=this.shadowRoot.querySelector("#body")){let children="slot"===target.localName?target.assignedNodes({flatten:!0}):[];0===children.length&&(children=target.children);for(var i=0;i<children.length;i++)if(this._validElementTest(children[i])&&(!status||!0!==children[i].getAttribute("contenteditable")&&"true"!=children[i].getAttribute("contenteditable")&&"contenteditable"!=children[i].getAttribute("contenteditable"))&&this.__applyNodeEditableState(children[i],status),_haxStore.HAXStore.isGridPlateElement(children[i])){let grandKids=children[i].querySelectorAll("*");for(var j=0;j<grandKids.length;j++)this._validElementTest(grandKids[j])&&this.__applyNodeEditableState(grandKids[j],status)}}__applyNodeEditableState(node,status=!0){let listenerMethod,haxRay=node.tagName.replace("-"," ").toLowerCase(),i=(0,_mobxEsm.toJS)(_haxStore.HAXStore.gizmoList).findIndex(j=>{if(j)return j.tag===node.tagName.toLowerCase()});if(-1!==i&&(haxRay=(0,_mobxEsm.toJS)(_haxStore.HAXStore.gizmoList)[i].title),"IMG"==node.tagName&&node.setAttribute("draggable",!1),status?(node.setAttribute("data-hax-ray",haxRay),listenerMethod="addEventListener"):(node.removeAttribute("data-hax-ray"),listenerMethod="removeEventListener"),node[listenerMethod]("drop",this.dropEvent.bind(this)),node[listenerMethod]("dragenter",this.dragEnter.bind(this)),node[listenerMethod]("dragleave",this.dragLeave.bind(this)),node[listenerMethod]("dragover",e=>{this.__dragMoving=!0,e.preventDefault()}),this._HTMLPrimativeTest(node)&&(status?node.setAttribute("contenteditable",status):node.removeAttribute("contenteditable"),node.querySelectorAll("a").length>0)){let links=node.querySelectorAll("a");for(var j=0,len2=links.length;j<len2;j++)status?links[j].setAttribute("contenteditable",status):links[j].removeAttribute("contenteditable"),links[j][listenerMethod]("click",e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()})}}undoManagerStackLogic(mutations){this.__dragMoving||(this.querySelectorAll(".hax-hovered").forEach(el=>{el.classList.remove("hax-hovered")}),super.undoManagerStackLogic(mutations))}dropEvent(e){if(this.editMode){this.__dragMoving=!1,this.undoManagerStackLogic({}),clearTimeout(gravityScrollTimer),_haxStore.HAXStore._lockContextPosition=!1,_haxStore.HAXStore.haxTray.activeTab="item-1";var local,target=null,eventPath=(0,_utils.normalizeEventPath)(e);target=e.target.closest("grid-plate")&&e.target.parentNode!=e.target.closest("grid-plate")?e.target.closest("grid-plate"):e.target.closest("[contenteditable],img")?e.target.closest("[contenteditable],img"):e.originalTarget?e.originalTarget:e.target,eventPath[0].classList.contains("column")?this.__slot=eventPath[0].getAttribute("id").replace("col","col-"):target.getAttribute("slot")&&(this.__slot=target.getAttribute("slot")),_haxStore.HAXStore.activeNode=target,this.querySelectorAll(".hax-hovered").forEach(el=>{el.classList.remove("hax-hovered")}),this.querySelectorAll(".active").forEach(el=>{el.classList.remove("active")});try{if(e.dataTransfer&&e.dataTransfer.items&&e.dataTransfer.items.length>0&&"file"===e.dataTransfer.items[0].kind){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();let tmp=document.createElement("p");e.target.closest("grid-plate")&&e.target.parentNode!=e.target.closest("grid-plate")?local=e.target.closest("grid-plate"):e.target.closest("[contenteditable],img")&&(local=e.target.closest("[contenteditable],img")),local&&local.tagName&&!["GRID-PLATE","HAX-BODY"].includes(local.tagName)||"GRID-PLATE"===eventPath[0].tagName?(local.getAttribute("slot")?tmp.setAttribute("slot",local.getAttribute("slot")):eventPath[0].classList.contains("column")?tmp.setAttribute("slot",eventPath[0].getAttribute("id").replace("col","col-")):tmp.removeAttribute("slot"),local.parentNode.insertBefore(tmp,local)):(eventPath[0].classList.contains("column")?tmp.setAttribute("slot",eventPath[0].getAttribute("id").replace("col","col-")):local&&"HAX-BODY"===local.tagName&&tmp.getAttribute("slot")&&tmp.removeAttribute("slot"),local?local.appendChild(tmp):this.appendChild(tmp)),e.placeHolderElement=tmp,this.dispatchEvent(new CustomEvent("place-holder-file-drop",{bubbles:!0,cancelable:!0,composed:!0,detail:e}))}else{if(target=_haxStore.HAXStore.__dragTarget,local=e.target,e.target.closest("grid-plate")&&e.target.parentNode!=e.target.closest("grid-plate")?local=e.target.closest("grid-plate"):e.target.closest("[contenteditable],img")&&(local=e.target.closest("[contenteditable],img")),local&&target&&this._validElementTest(target)&&target!==local){try{["GRID-PLATE","HAX-BODY"].includes(local.tagName)&&"GRID-PLATE"!==eventPath[0].tagName?(eventPath[0].classList.contains("column")?target.setAttribute("slot",eventPath[0].getAttribute("id").replace("col","col-")):"HAX-BODY"===local.tagName&&target.getAttribute("slot")&&target.removeAttribute("slot"),local.appendChild(target)):(local.getAttribute("slot")?target.setAttribute("slot",local.getAttribute("slot")):eventPath[0].classList.contains("column")?target.setAttribute("slot",eventPath[0].getAttribute("id").replace("col","col-")):target.removeAttribute("slot"),local.parentNode.insertBefore(target,local))}catch(e){console.warn(e)}e.preventDefault(),e.stopPropagation()}target&&this._validElementTest(target)&&"function"==typeof target.focus&&(_haxStore.HAXStore.activeNode=target,this.dispatchEvent(new CustomEvent("hax-drop-focus-event",{bubbles:!0,cancelable:!0,composed:!0,detail:this.activeNode})),this.scrollHere(this.activeNode),this.positionContextMenus())}}catch(e){console.warn(e)}}_haxStore.HAXStore.__dragTarget=null,this.__manageFakeEndCap(!1)}dragEnter(e){this.editMode&&e.target&&(this.__dragMoving=!0,e.preventDefault(),e.target&&e.target.classList&&e.target.classList.add("hax-hovered"),this.handleMousemove(e))}handleMousemove(e){var viewportX=e.clientX,viewportY=e.clientY,viewportWidth=document.documentElement.clientWidth,viewportHeight=document.documentElement.clientHeight,edgeBottom=viewportHeight-200,edgeRight=viewportWidth-200,isInLeftEdge=viewportX<200,isInRightEdge=viewportX>edgeRight,isInTopEdge=viewportY<200,isInBottomEdge=viewportY>edgeBottom;if(isInLeftEdge||isInRightEdge||isInTopEdge||isInBottomEdge){var documentWidth=Math.max(document.body.scrollWidth,document.body.offsetWidth,document.body.clientWidth,document.documentElement.scrollWidth,document.documentElement.offsetWidth,document.documentElement.clientWidth),documentHeight=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.body.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight,document.documentElement.clientHeight),maxScrollX=documentWidth-viewportWidth,maxScrollY=documentHeight-viewportHeight;!function checkForWindowScroll(){clearTimeout(gravityScrollTimer),function adjustWindowScroll(){var currentScrollX=window.pageXOffset,currentScrollY=window.pageYOffset,canScrollUp=currentScrollY>0,canScrollDown=currentScrollY<maxScrollY,canScrollLeft=currentScrollX>0,canScrollRight=currentScrollX<maxScrollX,nextScrollX=currentScrollX,nextScrollY=currentScrollY;if(isInLeftEdge&&canScrollLeft){nextScrollX-=25*((200-viewportX)/200)}else if(isInRightEdge&&canScrollRight){nextScrollX+=25*((viewportX-edgeRight)/200)}if(isInTopEdge&&canScrollUp){nextScrollY-=25*((200-viewportY)/200)}else if(isInBottomEdge&&canScrollDown){nextScrollY+=25*((viewportY-edgeBottom)/200)}return nextScrollX=Math.max(0,Math.min(maxScrollX,nextScrollX)),nextScrollY=Math.max(0,Math.min(maxScrollY,nextScrollY)),(nextScrollX!==currentScrollX||nextScrollY!==currentScrollY)&&(window.scrollTo(nextScrollX,nextScrollY),!0)}()&&(gravityScrollTimer=setTimeout(checkForWindowScroll,30))}()}else clearTimeout(gravityScrollTimer)}dragLeave(e){this.editMode&&e.target&&e.target.classList&&(this.__dragMoving=!0,e.target.classList.remove("hax-hovered"))}async _activeNodeChanged(newValue,oldValue){if(window.SimplePopoverManager.requestAvailability().opened=!1,await this.querySelectorAll(".hax-active").forEach(el=>{el.classList.remove("hax-active")}),this.editMode&&null!=newValue&&newValue.parentNode){let tag=newValue.tagName.toLowerCase();newValue.classList.add("hax-active"),_haxStore.HAXStore.isTextElement(newValue)||"HR"===newValue.tagName||_haxStore.HAXStore.isGridPlateElement(newValue)?(newValue.setAttribute("contenteditable",!0),this.setAttribute("contenteditable",!0)):(newValue.removeAttribute("contenteditable"),this.removeAttribute("contenteditable")),this._keepContextVisible(),this.contextMenus.text.realSelectedValue=tag}else null===newValue&&(this.hideContextMenus(),this.__oldActiveNode=oldValue);if(this.editMode&&_haxStore.HAXStore.runHook(oldValue,"activeElementChanged",[oldValue,!1])&&(this.__ignoreActive=!0),this.editMode&&_haxStore.HAXStore.runHook(newValue,"activeElementChanged",[newValue,!0])&&(this.__ignoreActive=!0),this.editMode&&oldValue){let oldSchema=_haxStore.HAXStore.haxSchemaFromTag(oldValue.tagName.toLowerCase());if("core"!=oldSchema.editingElement||oldValue.parentNode&&oldValue.parentNode.haxUIElement&&oldValue.parentNode===_haxStore.HAXStore.activeEditingElement){this.__ignoreActive=!0;let replacement=_haxStore.HAXStore.runHook(_haxStore.HAXStore.activeEditingElement,"activeElementChanged",[oldValue,!1]);if(replacement&&replacement!==oldValue){if(oldValue&&oldValue.getAttribute&&null!=oldValue.getAttribute("slot")&&replacement.setAttribute("slot",oldValue.getAttribute("slot")),oldSchema.saveOptions&&oldSchema.saveOptions.unsetAttributes&&oldSchema.saveOptions.unsetAttributes.length)for(var i in oldSchema.saveOptions.unsetAttributes)replacement.removeAttribute(oldSchema.saveOptions.unsetAttributes[i]);this.__applyNodeEditableState(replacement,this.editMode)}(0,_utils.unwrap)(_haxStore.HAXStore.activeEditingElement),_haxStore.HAXStore.activeEditingElement=null}}if(this.editMode&&newValue){let newSchema=_haxStore.HAXStore.haxSchemaFromTag(newValue.tagName);if(newSchema&&newSchema.editingElement&&"core"!=newSchema.editingElement){if(newSchema.editingElement.import){let basePath=_haxStore.HAXStore.pathFromUrl(decodeURIComponent(meta.url));await new Promise((res,rej)=>_require.default([`${basePath}../../${newSchema.editingElement.import}`],res,rej))}_haxStore.HAXStore.activeEditingElement=document.createElement(newSchema.editingElement.tag),newValue.getAttribute&&null!=newValue.getAttribute("slot")&&_haxStore.HAXStore.activeEditingElement.setAttribute("slot",newValue.getAttribute("slot")),newSchema.editingElement.callback&&newSchema.editingElement.callback(_haxStore.HAXStore.activeEditingElement),this.__ignoreActive=!0,(0,_utils.wrap)(newValue,_haxStore.HAXStore.activeEditingElement),_haxStore.HAXStore.runHook(_haxStore.HAXStore.activeEditingElement,"activeElementChanged",[newValue,!0])}}}_getPosition(element){return{x:element.offsetLeft-element.scrollLeft+element.clientLeft,y:element.offsetTop-element.scrollTop+element.clientTop}}_positionContextMenu(menu,target,xoffset,yoffset){if(null!=target){let pos=this._getPosition(target);menu.style.left=null!=xoffset?pos.x+xoffset+"px":pos.x+"px",menu.style.top=null!=yoffset?pos.y+yoffset+"px":pos.y+"px"}menu.setAttribute("on-screen","on-screen"),menu.classList.add("hax-context-visible","hax-context-menu-active")}_hideContextMenu(menu){menu.removeAttribute("on-screen"),menu.visible=!1,menu.classList.remove("hax-context-visible","hax-context-pin-top","hax-context-menu-active")}_tabKeyPressed(){if(this.activeNode&&_haxStore.HAXStore.getRange().cloneRange)try{let focus=!1,node=this.activeNode.parentNode;const activeNodeTagName=this.activeNode.parentNode.tagName;let range=_haxStore.HAXStore.getRange().cloneRange();var tagTest=range.commonAncestorContainer.tagName;if(void 0===tagTest&&(tagTest=range.commonAncestorContainer.parentNode.tagName),["UL","OL","LI"].includes(activeNodeTagName)||["UL","OL","LI"].includes(tagTest))this.polyfillSafe&&(this.__tabTrap=!0,this.__indentTrap=!0,document.execCommand("indent"));else for(;!focus;)null==node.nextSibling?focus=!0:"function"===node.nextSibling.focus?(node.nextSibling.focus(),focus=!0):node=node.nextSibling}catch(e){console.warn(e)}}_tabBackKeyPressed(){if(this.activeNode&&_haxStore.HAXStore.getRange().cloneRange)try{let node=this.activeNode.parentNode;const activeNodeTagName=this.activeNode.parentNode.tagName;let range=_haxStore.HAXStore.getRange().cloneRange();var tagTest=range.commonAncestorContainer.tagName;if(void 0===tagTest&&(tagTest=range.commonAncestorContainer.parentNode.tagName),["UL","OL","LI"].includes(activeNodeTagName)||["UL","OL","LI"].includes(tagTest))this.polyfillSafe&&(this.__tabTrap=!0,this.__indentTrap=!0,document.execCommand("outdent"));else{if(null!=node)for(;null!=node&&!this._validElementTest(node);)node=node.previousSibling;null!=node&&setTimeout(()=>{node.focus()},50)}}catch(e){console.warn(e)}}}_exports.HaxBody=HaxBody,window.customElements.define(HaxBody.tag,HaxBody)}));