import{LitElement,html,css}from"../../../lit-element/lit-element.js";import"../../simple-icon/lib/simple-icon-lite.js";import"../../hax-iconset/lib/simple-hax-iconset.js";import"./hax-context-item-menu.js";import"./hax-context-item.js";import"./hax-context-item-textop.js";import"./hax-toolbar.js";import"../../simple-popover/lib/simple-popover-selection.js";import{SimpleTourFinder}from"../../simple-popover/lib/SimpleTourFinder.js";import{HAXStore}from"./hax-store.js";import{autorun,toJS}from"../../../mobx/dist/mobx.esm.js";class HaxTextContext extends(SimpleTourFinder(LitElement)){static get styles(){return[css`
        :host {
          display: block;
          pointer-events: none;
        }
        :host [hidden] {
          display: none;
        }
        simple-popover-selection {
          display: flex;
        }
        .selected-buttons {
          transition: 0.1s all ease-in-out;
          width: 0;
        }
        :host([has-selected-text]) .selected-buttons {
          width: 100%;
        }
        #toolbar {
          overflow: hidden;
        }
        button {
          color: black;
          -webkit-justify-content: flex-start;
          justify-content: flex-start;
          font-size: 11px;
          line-height: 24px;
          margin: 0;
          padding: 0 4px;
          min-height: 24px;
        }
        button:hover {
          cursor: pointer;
          color: black;
        }
        simple-icon-lite {
          --simple-icon-height: 20px;
          --simple-icon-width: 20px;
          padding: 4px;
        }
        hax-context-item-textop,
        hax-context-item {
          transition: all 0.2s linear;
          visibility: visible;
          opacity: 1;
        }
        hax-context-item-textop[hidden],
        hax-context-item[hidden] {
          visibility: hidden;
          opacity: 0;
        }
        :host(.hax-context-pin-top) hax-toolbar {
          position: fixed;
          top: 0px;
          flex-direction: column;
        }
      `]}constructor(){super(),this.sourceView=!1,this.haxUIElement=!0,this.tourName="hax",setTimeout(()=>{this.addEventListener("hax-context-item-selected",this._haxContextOperation.bind(this)),window.addEventListener("hax-context-item-selected",this._haxInMenuContextOperation.bind(this))},0),this.formattingList=[{value:"p",icon:"hax:paragraph",text:"Paragraph"},{value:"ul",icon:"editor:format-list-bulleted",text:"Bulleted list"},{value:"ol",icon:"editor:format-list-numbered",text:"Numbered list"},{value:"h2",icon:"hax:h2",text:"Title"},{value:"h3",icon:"hax:h3",text:"Content heading"},{value:"h4",icon:"hax:h4",text:"Subheading"},{value:"h5",icon:"hax:h5",text:"Deep subheading"},{value:"blockquote",icon:"editor:format-quote",text:"Blockquote"},{value:"code",icon:"icons:code",text:"Code"}],this.realSelectedValue="p",this.formatIcon="hax:format-textblock",this.isSafari=this._isSafari(),autorun(()=>{this.hasSelectedText=toJS(HAXStore.haxSelectedText).length>0}),autorun(()=>{toJS(HAXStore.editMode);const activeNode=toJS(HAXStore.activeNode);if(activeNode&&activeNode.tagName){let schema=HAXStore.haxSchemaFromTag(activeNode.tagName);this.sourceView=schema.canEditSource}this.shadowRoot&&this.shadowRoot.querySelector("simple-popover-selection")&&(this.shadowRoot.querySelector("simple-popover-selection").opened=!1),activeNode&&HAXStore.isTextElement(activeNode)&&this.shadowRoot.querySelector('button[value="'+activeNode.tagName.toLowerCase()+'"]')?this.updateTextIconSelection(activeNode.tagName.toLowerCase()):activeNode&&"LI"===activeNode.tagName&&this.shadowRoot.querySelector('button[value="'+activeNode.parentNode.tagName.toLowerCase()+'"]')&&this.updateTextIconSelection(activeNode.parentNode.tagName.toLowerCase())})}render(){return html`
      <hax-toolbar id="toolbar">
        <simple-popover-selection
          slot="primary"
          @simple-popover-selection-changed="${this.textFormatChanged}"
          auto
          orientation="tb"
          id="textformat"
        >
          <div slot="style">
            simple-popover-manager button { color: black; font-size: 10px
            !important; margin: 0; padding: 4px; text-align:left; overflow:
            hidden; min-height: unset; width: 100%; display: block;
            justify-content: start; align-items: center; border: 0; }
            simple-popover-manager button simple-icon-lite {
            --simple-icon-height: 18px; --simple-icon-width: 18px; margin-right:
            8px; }
          </div>
          <hax-context-item
            action
            mini
            slot="button"
            id="formatsize"
            icon="${this.formatIcon}"
            label="Text format"
            data-simple-tour-stop
            data-stop-title="label"
          >
            <div slot="tour" data-stop-content>
              Change how the text is structured and visualized in the page.
            </div>
          </hax-context-item>
          ${this.formattingList.map(val=>html` <button slot="options" value="${val.value}">
                <simple-icon-lite icon="${val.icon}"></simple-icon-lite>
                ${val.text}
              </button>`)}
        </simple-popover-selection>
        <!-- comment this in when rich-text-editor is viable -->
        <!--
        <hax-context-item
          mini
          action
          hidden
          slot="primary"
          icon="icons:flip-to-back"
          label="Full text editor"
          event-name="hax-full-text-editor-toggle"
        ></hax-context-item> -->
        <hax-context-item
          mini
          action
          slot="primary"
          icon="icons:code"
          label="Modify HTML source"
          ?hidden="${!this.sourceView}"
          event-name="hax-source-view-toggle"
        ></hax-context-item>
        <hax-context-item-textop
          mini
          action
          slot="primary"
          icon="editor:format-list-bulleted"
          event-name="text-tag-ul"
          label="Bulleted list"
          .hidden="${!this._showLists}"
        ></hax-context-item-textop>
        <hax-context-item-textop
          mini
          action
          slot="primary"
          icon="editor:format-list-numbered"
          label="Numbered list"
          event-name="text-tag-ol"
          .hidden="${!this._showLists}"
        ></hax-context-item-textop>
        <hax-context-item-textop
          mini
          action
          slot="primary"
          icon="editor:format-indent-decrease"
          label="Outdent"
          event-name="text-outdent"
          .hidden="${!this._showIndent}"
        ></hax-context-item-textop>
        <hax-context-item-textop
          mini
          action
          slot="primary"
          icon="editor:format-indent-increase"
          label="Indent"
          event-name="text-indent"
          .hidden="${!this._showIndent}"
        ></hax-context-item-textop>
        <hax-context-item-textop
          mini
          action
          slot="primary"
          icon="editor:format-bold"
          label="Bold"
          class="selected-buttons"
          event-name="text-bold"
          ?hidden="${!this.hasSelectedText}"
        ></hax-context-item-textop>
        <hax-context-item-textop
          mini
          action
          slot="primary"
          icon="editor:format-italic"
          label="Italic"
          class="selected-buttons"
          event-name="text-italic"
          ?hidden="${!this.hasSelectedText}"
        ></hax-context-item-textop>
        <hax-context-item-textop
          mini
          action
          slot="primary"
          icon="editor:insert-link"
          label="Link"
          class="selected-buttons"
          event-name="text-link"
          ?hidden="${!this.hasSelectedText}"
        ></hax-context-item-textop>
        <hax-context-item-textop
          mini
          action
          slot="primary"
          icon="mdextra:unlink"
          label="Remove link"
          class="selected-buttons"
          event-name="text-unlink"
          ?hidden="${!this.hasSelectedText}"
        ></hax-context-item-textop>
        <hax-context-item-textop
          mini
          action
          slot="primary"
          icon="editor:format-clear"
          label="Remove format"
          class="selected-buttons"
          event-name="text-remove-format"
          ?hidden="${!this.hasSelectedText}"
        ></hax-context-item-textop>
        <hax-context-item
          mini
          action
          slot="primary"
          icon="hax:add-brick"
          label="Add element to selection"
          class="selected-buttons"
          event-name="insert-inline-gizmo"
          ?hidden="${this.isSafari||!this.hasSelectedText}"
        ></hax-context-item>
        <hax-context-item-textop
          mini
          action
          slot="primary"
          icon="hax:add-brick"
          label="Add element to selection"
          class="selected-buttons"
          event-name="insert-inline-gizmo"
          ?hidden="${!this.isSafari||!this.hasSelectedText}"
        ></hax-context-item-textop>
        <hax-context-item-textop
          action
          menu
          slot="more"
          icon="mdextra:subscript"
          event-name="text-subscript"
          ?hidden="${!this.hasSelectedText}"
          >Subscript</hax-context-item-textop
        >
        <hax-context-item-textop
          action
          menu
          slot="more"
          icon="mdextra:superscript"
          event-name="text-superscript"
          ?hidden="${!this.hasSelectedText}"
          >Superscript</hax-context-item-textop
        >
        <hax-context-item-textop
          action
          menu
          slot="more"
          icon="editor:format-underlined"
          event-name="text-underline"
          ?hidden="${!this.hasSelectedText}"
          >Underline</hax-context-item-textop
        >
        <hax-context-item-textop
          action
          menu
          slot="more"
          icon="editor:format-strikethrough"
          event-name="text-strikethrough"
          ?hidden="${!this.hasSelectedText}"
          >Cross out</hax-context-item-textop
        >
        <hax-context-item-textop
          action
          menu
          slot="more"
          icon="hardware:keyboard-arrow-up"
          event-name="insert-above-active"
          >Insert item above</hax-context-item-textop
        >
        <hax-context-item-textop
          action
          menu
          slot="more"
          icon="hardware:keyboard-arrow-down"
          event-name="insert-below-active"
          >Insert item below</hax-context-item-textop
        >
      </hax-toolbar>
    `}static get tag(){return"hax-text-context"}static get properties(){return{_showIndent:{type:Boolean},_showLists:{type:Boolean},realSelectedValue:{type:String},sourceView:{type:Boolean},formattingList:{type:Array},hasSelectedText:{type:Boolean,attribute:"has-selected-text",reflect:!0},formatIcon:{type:String,attribute:"format-icon"},isSafari:{type:Boolean,attribute:"is-safari"}}}textFormatChanged(e){this.shadowRoot.querySelector("simple-popover-selection").opened=!1,this.updateTextIconSelection(e.detail.getAttribute("value")),this.dispatchEvent(new CustomEvent("hax-context-item-selected",{bubbles:!0,cancelable:!0,composed:!0,detail:{eventName:"text-tag",value:this.realSelectedValue}}))}updateTextIconSelection(tag){this.realSelectedValue=tag,this.shadowRoot.querySelector("[data-simple-popover-selection-active]")&&this.shadowRoot.querySelector("[data-simple-popover-selection-active]").removeAttribute("data-simple-popover-selection-active");let localItem=this.shadowRoot.querySelector('button[value="'+this.realSelectedValue+'"]');localItem&&(localItem.setAttribute("data-simple-popover-selection-active",!0),this.formatIcon=localItem.querySelector("simple-icon-lite").getAttribute("icon"))}updated(changedProperties){changedProperties.forEach((oldValue,propName)=>{"realSelectedValue"==propName&&(this._showIndent=this._computeShowIndent(this.realSelectedValue),"p"==this.realSelectedValue?this._showLists=!0:this._showLists=!1)})}firstUpdated(changedProperties){super.firstUpdated&&super.firstUpdated(changedProperties),toJS(HAXStore.activeNode)&&toJS(HAXStore.activeNode).tagName&&this.updateTextIconSelection(toJS(HAXStore.activeNode).tagName.toLowerCase())}_computeShowIndent(realSelectedValue){return!(!HAXStore.computePolyfillSafe()||"li"!=realSelectedValue&&"ol"!=realSelectedValue&&"ul"!=realSelectedValue)}_haxInMenuContextOperation(e){let prevent=!1;switch(e.detail.eventName){case"insert-above-active":case"insert-below-active":this.shadowRoot.querySelector("simple-popover-selection").opened=!1;break;case"text-underline":document.execCommand("underline"),prevent=!0;break;case"text-subscript":document.execCommand("subscript"),prevent=!0;break;case"text-superscript":document.execCommand("superscript"),prevent=!0;break;case"text-strikethrough":document.execCommand("strikeThrough"),prevent=!0}prevent&&(this.shadowRoot.querySelector("simple-popover-selection").opened&&(this.shadowRoot.querySelector("simple-popover-selection").opened=!1),e.preventDefault(),e.stopPropagation())}_haxContextOperation(e){let detail=e.detail,selection=HAXStore.getSelection(),prevent=!1;switch(detail.eventName){case"insert-inline-gizmo":if(HAXStore._tmpSelection&&HAXStore.editMode)try{"HAX-BODY"!==HAXStore._tmpRange.startContainer.parentNode.parentNode.tagName&&"HAX-BODY"!==HAXStore._tmpRange.startContainer.parentNode.parentNode.parentNode.tagName||(HAXStore.activePlaceHolder=HAXStore._tmpRange)}catch(err){}if(null!=HAXStore.activePlaceHolder){let values={text:HAXStore.activePlaceHolder.toString()},type="inline",haxElements=HAXStore.guessGizmo(type,values);haxElements.length>0&&HAXStore.haxAppPicker.presentOptions(haxElements,type,"Transform selected text to..","gizmo")}break;case"text-bold":document.execCommand("bold"),prevent=!0;break;case"text-italic":document.execCommand("italic"),prevent=!0;break;case"text-remove-format":document.execCommand("removeFormat"),prevent=!0;break;case"text-link":var href="";selection&&selection.focusNode&&selection.focusNode.parentNode&&void 0!==selection.focusNode.parentNode.href&&(href=selection.focusNode.parentNode.href);let url=prompt("Enter a URL:",href);url&&(document.execCommand("createLink",!1,url),selection.focusNode.parentNode&&(selection.focusNode.parentNode.setAttribute("contenteditable",!0),selection.focusNode.parentNode.removeEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()}),selection.focusNode.parentNode.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()})),prevent=!0);break;case"text-unlink":document.execCommand("unlink"),prevent=!0;break;case"text-indent":HAXStore.activeHaxBody.__indentTrap=!0,document.execCommand("indent"),prevent=!0;break;case"text-outdent":HAXStore.activeHaxBody.__indentTrap=!0,document.execCommand("outdent"),prevent=!0}prevent&&(e.preventDefault(),e.stopPropagation())}_isSafari(){let ua=navigator.userAgent.toLowerCase();return!(-1==ua.indexOf("safari")||ua.indexOf("chrome")>-1)}}window.customElements.define(HaxTextContext.tag,HaxTextContext);export{HaxTextContext};